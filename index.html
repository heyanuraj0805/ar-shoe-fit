<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FIT.AI PRO | Automated Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        video, canvas { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
        video { z-index: 1; }
        canvas { z-index: 2; pointer-events: none; }
        .hud { position: absolute; inset: 0; z-index: 10; pointer-events: none; padding: 2rem; display: flex; flex-direction: column; justify-content: space-between; }
        .interactive { pointer-events: auto; }
        .status-box { background: rgba(0,0,0,0.8); border: 1px solid #4f46e5; padding: 1rem; border-radius: 1rem; color: white; width: 220px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { PoseLandmarker, FilesetResolver } from "https://cdn.skypack.dev/@mediapipe/tasks-vision@0.10.0";
        window.PoseLandmarker = PoseLandmarker;
        window.FilesetResolver = FilesetResolver;
    </script>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const ARApp = () => {
            const [active, setActive] = useState(false);
            const [engineStatus, setEngineStatus] = useState("Initializing...");
            const [trackingLocked, setTrackingLocked] = useState(false);
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const landmarkerRef = useRef(null);

            useEffect(() => {
                async function init() {
                    const vision = await window.FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
                    landmarkerRef.current = await window.PoseLandmarker.createFromOptions(vision, {
                        baseOptions: {
                            modelAssetPath: `https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task`,
                            delegate: "GPU"
                        },
                        runningMode: "VIDEO",
                        minPoseDetectionConfidence: 0.3, // Lowered for easier detection
                        minTrackingConfidence: 0.3
                    });
                    setEngineStatus("Engine Ready");
                }
                init();
            }, []);

            const startScanner = async () => {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                videoRef.current.srcObject = stream;
                setActive(true);
                requestAnimationFrame(loop);
            };

            const loop = () => {
                if (landmarkerRef.current && videoRef.current?.readyState === 4) {
                    const results = landmarkerRef.current.detectForVideo(videoRef.current, performance.now());
                    const ctx = canvasRef.current.getContext('2d');
                    ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);

                    if (results.landmarks?.length > 0) {
                        setTrackingLocked(true);
                        const pts = results.landmarks[0];
                        const ankle = pts[28]; // Anchor
                        const toe = pts[32];   // Tip

                        // Draw Green Dots (Visual Feedback)
                        ctx.fillStyle = "#00ff00";
                        [pts[28], pts[30], pts[32]].forEach(p => {
                            ctx.beginPath();
                            ctx.arc(p.x * canvasRef.current.width, p.y * canvasRef.current.height, 8, 0, 7);
                            ctx.fill();
                        });
                    } else {
                        setTrackingLocked(false);
                    }
                }
                requestAnimationFrame(loop);
            };

            return (
                <div className="relative w-full h-screen">
                    <video ref={videoRef} autoPlay playsInline muted />
                    <canvas ref={canvasRef} width={window.innerWidth} height={window.innerHeight} />

                    <div className="hud">
                        <div className="flex justify-between items-start">
                            <div className="status-box">
                                <p className="text-[10px] uppercase font-bold opacity-50 mb-1 tracking-widest">Engine Start</p>
                                <div className="flex items-center gap-2">
                                    <div className={`w-2 h-2 rounded-full ${trackingLocked ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                                    <span className="font-bold">{trackingLocked ? "Tracking Locked" : engineStatus}</span>
                                </div>
                                {!trackingLocked && active && (
                                    <p className="text-[10px] text-orange-400 mt-2 font-bold animate-pulse">MOVE 5FT AWAY FROM CAMERA</p>
                                )}
                            </div>
                            <h1 className="text-white text-2xl font-black italic tracking-tighter">FIT.AI PRO</h1>
                        </div>

                        {!active && (
                            <button onClick={startScanner} className="interactive self-center bg-indigo-600 text-white px-12 py-5 rounded-full font-black text-xl shadow-2xl">
                                START SCANNER
                            </button>
                        )}

                        <div className="flex gap-4 overflow-x-auto pb-4 interactive">
                            {['ðŸ‘Ÿ', 'ðŸ‘ž', 'ðŸ¥¾', 'ðŸ‘ '].map(s => (
                                <button key={s} className="min-w-[80px] h-[80px] bg-white/20 backdrop-blur-md rounded-2xl text-3xl border border-white/10">{s}</button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ARApp />);
    </script>
</body>
</html>
