<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FIT.AI | Intelligent AR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; height: 100vh; color: white; }
        .viewport { position: relative; width: 100vw; height: 100vh; }
        video, canvas { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
        video { z-index: 1; }
        canvas { z-index: 2; pointer-events: none; }
        .hud { position: absolute; inset: 0; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 1.5rem; }
        .interactive { pointer-events: auto; }
        /* Right Side Status Panel */
        .status-panel { position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%); background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.3); padding: 1rem; border-radius: 1rem; backdrop-filter: blur(4px); max-width: 180px; }
        .indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .shoe-btn { background: #fff; color: #000; min-width: 80px; height: 80px; border-radius: 20px; font-size: 2.5rem; display: flex; align-items: center; justify-content: center; }
        .shoe-btn.active { background: #4f46e5; color: #fff; border: 3px solid white; scale: 1.1; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { PoseLandmarker, FilesetResolver } from "https://cdn.skypack.dev/@mediapipe/tasks-vision@0.10.0";
        window.PoseLandmarker = PoseLandmarker;
        window.FilesetResolver = FilesetResolver;
    </script>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const ARStudio = () => {
            const [active, setActive] = useState(false);
            const [shoe, setShoe] = useState('ðŸ‘Ÿ');
            const [guidance, setGuidance] = useState({ msg: "Initializing...", color: "bg-yellow-500", detected: false });
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const landmarkerRef = useRef(null);

            useEffect(() => {
                async function init() {
                    const vision = await window.FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
                    landmarkerRef.current = await window.PoseLandmarker.createFromOptions(vision, {
                        baseOptions: {
                            modelAssetPath: `https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task`,
                            delegate: "GPU"
                        },
                        runningMode: "VIDEO"
                    });
                    setGuidance({ msg: "Ready to Scan", color: "bg-green-500", detected: false });
                }
                init();
            }, []);

            const startCamera = async () => {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                videoRef.current.srcObject = stream;
                setActive(true);
                requestAnimationFrame(loop);
            };

            const loop = () => {
                if (landmarkerRef.current && videoRef.current?.readyState === 4) {
                    const results = landmarkerRef.current.detectForVideo(videoRef.current, performance.now());
                    processResults(results);
                }
                requestAnimationFrame(loop);
            };

            const processResults = (results) => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (results.landmarks?.length > 0) {
                    const pts = results.landmarks[0];
                    const ankle = pts[28]; 
                    const knee = pts[26];
                    const toe = pts[32];

                    // GUIDANCE LOGIC
                    if (ankle.visibility < 0.4) {
                        setGuidance({ msg: "Stand Further Back", color: "bg-orange-500", detected: false });
                    } else if (knee.visibility < 0.4) {
                        setGuidance({ msg: "Show Your Knees", color: "bg-blue-500", detected: true });
                    } else {
                        setGuidance({ msg: "Tracking Stable", color: "bg-green-500", detected: true });
                        
                        // DRAWING SHOE
                        const x = ankle.x * canvas.width;
                        const y = ankle.y * canvas.height;
                        const angle = Math.atan2((toe.y - ankle.y), (toe.x - ankle.x));
                        const size = Math.sqrt(Math.pow((toe.x-ankle.x)*canvas.width, 2) + Math.pow((toe.y-ankle.y)*canvas.height, 2)) * 1.5;

                        ctx.save();
                        ctx.translate(x, y);
                        ctx.rotate(angle);
                        ctx.font = `${size}px Arial`;
                        ctx.textAlign = "center";
                        ctx.fillText(shoe, size/2, 0); 
                        ctx.restore();
                    }
                } else {
                    setGuidance({ msg: "No Foot Detected", color: "bg-red-500", detected: false });
                }
            };

            return (
                <div className="viewport">
                    <video ref={videoRef} autoPlay playsInline muted />
                    <canvas ref={canvasRef} width={window.innerWidth} height={window.innerHeight} />
                    
                    <div className="hud">
                        {/* Status Header */}
                        <div className="bg-white p-3 rounded-xl self-start interactive text-indigo-600 font-bold">FIT.AI PRO</div>

                        {/* Right Guidance Panel */}
                        <div className="status-panel text-green-400">
                            <h3 className="text-[10px] uppercase font-black opacity-60 mb-2">Engine Status</h3>
                            <div className="flex items-center mb-3">
                                <span className={`indicator ${guidance.color} animate-pulse`}></span>
                                <span className="text-xs font-bold leading-tight">{guidance.msg}</span>
                            </div>
                            <hr className="border-green-400/20 mb-3" />
                            <p className="text-[9px] leading-relaxed opacity-80">
                                {guidance.detected 
                                    ? "Foot localized. Keep camera steady for accurate scaling." 
                                    : "Move camera 5-6 feet away from your legs to start tracking."}
                            </p>
                        </div>

                        {!active && (
                            <button onClick={startCamera} className="interactive bg-indigo-600 text-white px-10 py-4 rounded-full font-bold self-center shadow-2xl">
                                START SCANNER
                            </button>
                        )}

                        {/* Style Selector */}
                        <div className="flex gap-4 overflow-x-auto pb-8 interactive px-4">
                            {['ðŸ‘Ÿ', 'ðŸ‘ž', 'ðŸ¥¾', 'ðŸ‘ '].map(s => (
                                <button key={s} onClick={() => setShoe(s)} className={`shoe-btn ${shoe === s ? 'active' : ''}`}>{s}</button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ARStudio />);
    </script>
</body>
</html>
